<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE robot PUBLIC "-//YARP//DTD yarprobotinterface 3.0//EN" "http://www.yarp.it/DTD/yarprobotinterfaceV3.0.dtd">
<robot name="Human-HDE" build=0 portprefix="human-state-provider-1">


    <device type="transformServer" name="TransformServer">
        <param name="transforms_lifetime">0.2</param>
        <group name="ROS">
            <param name="enable_ros_publisher">true</param>
            <param name="enable_ros_subscriber">false</param>
        </group>
    </device>

    <device type="iwear_remapper" name="IWearRemapper">
        <param name="wearableDataPorts">(/iFeelSuit/WearableData/data:o)</param>
    </device>

    <device type="human_state_provider" name="HumanStateProvider">
        <param name="period">0.0167</param>
        <param extern-name="model" name="urdf">humanSubject03_48dof.urdf</param>
        <param name="floatingBaseFrame">Pelvis</param>
        <!-- ikSolver options: pairwised, global, dynamical -->
        <param name="ikSolver">dynamical</param>
        <param name="allowIKFailures">true</param>
        <param name="useDirectBaseMeasurement ">false</param>
        <!-- optimization parameters -->
        <param name="maxIterationsIK">300</param>
        <param name="ikLinearSolver">ma27</param>
        <param name="ikPoolSizeOption">2</param>
        <param name="posTargetWeight">0.0</param>
        <param name="rotTargetWeight">1.0</param>
        <param name="costRegularization">0.000001</param>
        <param name="costTolerance">0.001</param>
        <!-- inverse velocity kinematics parameters -->
        <!-- inverseVelocityKinematicsSolver values:
        QP
        moorePenrose,
        completeOrthogonalDecomposition,
        leastSquare,
        choleskyDecomposition,
        sparseCholeskyDecomposition,
        robustCholeskyDecomposition,
        sparseRobustCholeskyDecomposition -->
        <param name='inverseVelocityKinematicsSolver'>QP</param>
        <param name="linVelTargetWeight">1.0</param>
        <param name="angVelTargetWeight">1.0</param>
        <!-- integration based IK parameters -->
        <param name='dynamicalIKJointVelocityLimit'>10.0</param> <!-- comment or -1.0 for no limits -->
        <param name="dynamicalIKMeasuredVelocityGainLinRot">(1.0 1.0)</param>
        <param name="dynamicalIKCorrectionGainsLinRot">(60.0 20.0)</param>
        <param name="dynamicalIKIntegralCorrectionGainsLinRot">(0.0 0.0)</param>
        <group name="WEARABLE_SENSOR_TARGETS">
            <!-- LinkName, WearableSensorName, TargetType-->
            <param name="target_Pelvis">(Pelvis, iFeelSuit::vLink::Node#3, orientationAndVelocity)</param>
            <param name="target_T8">(T8, iFeelSuit::vLink::Node#6, orientationAndVelocity)</param>
            <param name="target_RightUpperArm">(RightUpperArm, iFeelSuit::vLink::Node#7, orientationAndVelocity)</param> 
            <param name="target_RightForeArm">(RightForeArm, iFeelSuit::vLink::Node#8, orientationAndVelocity)</param>
            <param name="target_LeftUpperArm">(LeftUpperArm, iFeelSuit::vLink::Node#5, orientationAndVelocity)</param>
            <param name="target_LeftForeArm">(LeftForeArm, iFeelSuit::vLink::Node#4, orientationAndVelocity)</param>
            <param name="target_RightUpperLeg">(RightUpperLeg, iFeelSuit::vLink::Node#11, orientationAndVelocity)</param>
            <param name="target_RightLowerLeg">(RightLowerLeg, iFeelSuit::vLink::Node#12, orientationAndVelocity)</param>
            <param name="target_RightFoot">(RightFoot, iFeelSuit::vLink::Node#2, orientationAndVelocity)</param>
            <param name="target_LeftUpperLeg">(LeftUpperLeg, iFeelSuit::vLink::Node#9, orientationAndVelocity)</param>
            <param name="target_LeftLowerLeg">(LeftLowerLeg, iFeelSuit::vLink::Node#10, orientationAndVelocity)</param>
            <param name="target_LeftFoot">(LeftFoot, iFeelSuit::vLink::Node#1, orientationAndVelocity)</param>
            <param name="target_RightToe">(RightToe, iFeelSuit::ft6D::Node#2, floorContact)</param>
            <param name="target_LeftToe">(LeftToe, iFeelSuit::ft6D::Node#1, floorContact)</param>
        </group>
        <group name="CONTACT_TRESHOLDS">
            <param name="target_LeftToe">60.0</param>
            <param name="target_RightToe">60.0</param>
        </group>
        <param name="jointList">("jT9T8_rotx",
                                 "jT9T8_rotz",
                                 "jRightShoulder_rotx",
                                 "jRightShoulder_roty",
                                 "jRightShoulder_rotz",
                                 "jRightElbow_roty",
                                 "jRightElbow_rotz",
                                 "jLeftShoulder_rotx",
                                 "jLeftShoulder_roty",
                                 "jLeftShoulder_rotz",
                                 "jLeftElbow_roty",
                                 "jLeftElbow_rotz",
                                 "jLeftHip_rotx",
                                 "jLeftHip_roty",
                                 "jLeftHip_rotz",
                                 "jLeftKnee_roty",
                                 "jLeftKnee_rotz"
                                 "jLeftAnkle_rotx",
                                 "jLeftAnkle_roty",
                                 "jLeftAnkle_rotz",
                                 "jLeftBallFoot_roty",
                                 "jRightHip_rotx",
                                 "jRightHip_roty",
                                 "jRightHip_rotz",
                                 "jRightKnee_roty",
                                 "jRightKnee_rotz",
                                 "jRightAnkle_rotx",
                                 "jRightAnkle_roty",
                                 "jRightAnkle_rotz",
                                 "jRightBallFoot_roty",
                                 "jL5S1_roty")
        </param>
        <group name="MEASUREMENT_TO_LINK_TRANSFORMS">
            <param name="target_LeftUpperLeg">( 1.0   0.0   0.0  0.0
                                                0.0   0.0  -1.0  0.0
                                                0.0   1.0   0.0  0.0
                                                0.0   0.0   0.0  1.0)</param>
            <param name="target_LeftLowerLeg">( 1.0   0.0   0.0  0.0
                                                0.0   0.0  -1.0  0.0
                                                0.0   1.0   0.0  0.0
                                                0.0   0.0   0.0  1.0)</param>
            <param name="target_RightUpperLeg">( 1.0   0.0   0.0  0.0
                                                 0.0   0.0   1.0  0.0
                                                 0.0  -1.0   0.0  0.0
                                                 0.0   0.0   0.0  1.0)</param>
            <param name="target_RightLowerLeg">( 1.0   0.0   0.0  0.0
                                                 0.0   0.0   1.0  0.0
                                                 0.0  -1.0   0.0  0.0
                                                 0.0   0.0   0.0  1.0)</param>
            <param name="target_Pelvis">( 0.0   1.0   0.0  0.0
                                          0.0   0.0  -1.0  0.0
                                         -1.0   0.0   0.0  0.0
                                          0.0   0.0   0.0  1.0)</param>
            <param name="target_T8">( 0.0   1.0   0.0  0.0
                                      0.0   0.0   1.0  0.0
                                      1.0   0.0   0.0  0.0
                                      0.0   0.0   0.0  1.0)</param>
            <param name="target_RightFoot">(  0.0   1.0   0.0  0.0
                                             -1.0   0.0   0.0  0.0
                                              0.0   0.0   1.0  0.0
                                              0.0   0.0   0.0  1.0)</param>
            <param name="target_LeftFoot">(  0.0   1.0   0.0  0.0
                                            -1.0   0.0   0.0  0.0
                                             0.0   0.0   1.0  0.0
                                             0.0   0.0   0.0  1.0)</param>
        </group>
        <group name="CUSTOM_CONSTRAINTS">
            <!-- check issue https://github.com/robotology/human-dynamics-estimation/issues/132 for more info-->
            <!-- note that a group can not be empty, otherwise it returns error-->
            <!-- custom joint limits velocities-->
            <!--param name="custom_joints_velocity_limits_names">(neck_roll, neck_pitch)</param-->
            <param name="custom_joints_velocity_limits_names">()</param>
            <!-- the upper bound is "+", while the lower bounds are "-" -->
            <!--param name="custom_joints_velocity_limits_values">(10.0, 15.0)</param-->
            <param name="custom_joints_velocity_limits_values">()</param>
            <!-- **** base velocity limit: x, y, z, roll, pitch, yaw ****-->
            <param name="base_velocity_limit_upper_buond">(100.0, 100.0, 100.0 , 100.0, 100.0, 100.0 )</param>
            <param name="base_velocity_limit_lower_buond">(-100.0, -100.0, -100.0, -100.0, -100.0, -100.0 )</param>
            <!-- Custom joint Configuration constraints-->
            <!-- if the boudary value is inf, I will use -1000.0 rad, or +1000.0 rad-->
            <param name="custom_constraint_variables">(jLeftKnee_rotz, jRightKnee_rotz, jLeftHip_rotx, jRightHip_rotx)</param>
            <param name="custom_constraint_matrix"> (
                ( 1.0,    0.0,    0.0,    0.0),
                (-1.0,    0.0,    0.0,    0.0),
                ( 0.0,    1.0,    0.0,    0.0),
                ( 0.0,   -1.0,    0.0,    0.0),
                ( 0.0,    0.0,    1.0,    0.0),
                ( 0.0,    0.0,    0.0,    1.0))</param>
            <param name="custom_constraint_lower_bound"> (0.0, 0.0, 0.0, 0.0,   0.0, -100.0)</param>
            <param name="custom_constraint_upper_bound"> (0.0, 0.0, 0.0, 0.0, 100.0,    0.0)</param>
            <!-- The following two parameters should be set always , if not set they are by default 0.5 -->
            <param name="k_u">0.5</param>
            <param name="k_l">0.5</param>
        </group>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanStateProviderLabel">IWearRemapper</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_state_wrapper" name="HumanStateWrapper">
        <param name="period">0.02</param>
        <param name="outputPort">/HDE/HumanStateWrapper/state:o</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanStateWrapperLabel">HumanStateProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="wearable_targets_wrapper" name="WearableTargetsWrapper">
        <param name="period">0.01</param>
        <param name="outputPort">/HDE/WearableTargetsWrapper/state:o</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanStateWrapperLabel">HumanStateProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_state_publisher" name="HumanStatePublisher">
        <param name="period">0.02</param>
        <param name="baseTFName">/Human/Pelvis</param>
        <param name="humanJointsTopic">/Human/joint_states</param>
        <param name="basePositionOffset">(0.0 0.0 0.0)</param>
	<param name="baseOrientationOffset">(0.0 0.0 0.0 0.0)</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanStatePublisherLabel">HumanStateProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_wrench_provider" name="HumanWrenchProvider">
        <param name="period">0.020</param>
        <param extern-name="model" name="human_urdf">humanSubject03_48dof.urdf</param>
        <param extern-name="human_mass" name="human_mass">70.0</param>
        <param extern-name="base_name" name="base_name">Pelvis</param>
        <param name="pHRIScenario">false</param>
        <param name="number_of_sources">4</param>
        <param name="sources">(iFeelSuit::ft6D::Node#1 iFeelSuit::ft6D::Node#2 LeftHandCOM RightHandCOM)</param>
        <group name="iFeelSuit::ft6D::Node#1">
            <param name="sensorName">iFeelSuit::ft6D::Node#1</param>
            <param name="outputFrame">LeftFoot</param>
            <param name="type">fixed</param>
            <param name="rotation">(1.0 0.0 0.0
                                    0.0 1.0 0.0
                                    0.0 0.0 1.0)</param>
            <param name="position">(0.0 0.0 0.0)</param>
        </group>
        <group name="iFeelSuit::ft6D::Node#2">
            <param name="sensorName">iFeelSuit::ft6D::Node#2</param>
            <param name="outputFrame">RightFoot</param>
            <param name="type">fixed</param>
            <param name="rotation">(1.0 0.0 0.0
                                    0.0 1.0 0.0
                                    0.0 0.0 1.0)</param>
            <param name="position">(0.0 0.0 0.0)</param>
        </group>
        <group name="LeftHandCOM">
            <param name="sensorName">none</param>
            <param name="outputFrame">LeftHandCOM</param>
            <param name="type">dummy</param>
            <param name="value">(0.0 0.0 0.0 0.0 0.0 0.0)</param>
        </group>
        <group name="RightHandCOM">
            <param name="sensorName">none</param>
            <param name="outputFrame">RightHandCOM</param>
            <param name="type">dummy</param>
            <param name="value">(0.0 0.0 0.0 0.0 0.0 0.0)</param>
        </group>
        <!-- MAPEstParams -->
        <!-- This group contains information related to the use of a
             Maximum-A-Posteriori estimator to estimate the value of wrenches
            after the tranforms are applied -->
        <group name="MAPEstParams">
            <param extern-name="useMAPEst" name="useMAPEst">true</param>
            <group name="cov_measurements_NET_EXT_WRENCH_SENSOR">
                <param name="value">1e-09</param>
                <param name="specificElements">(LeftFoot RightFoot LeftHandCOM RightHandCOM)</param>
                <param name="LeftHandCOM">(1e06 1e06 1e06 1e-06 1e-06 1e-06)</param>
                <param name="RightHandCOM">(1e06 1e06 1e06 1e-06 1e-06 1e-06)</param>
                <param name="LeftFoot">(1e03 1e03 1e-06 1e03 1e03 1e03)</param>
                <param name="RightFoot">(1e03 1e03 1e-06 1e03 1e03 1e03)</param>
            </group>
            <param name="cov_measurements_RCM_SENSOR">(1e-6 1e-6 1e-6 1e03 1e03 1e03)</param>
            <param name="mu_dyn_variables">1e-9</param>
            <param name="cov_dyn_variables">1e01</param>
        </group>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanStateProviderLabel">HumanStateProvider</elem>
                <elem name="HumanWrenchProviderLabelFTShoeLeft">IWearRemapper</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach" />
    </device>

    <device type="analogServer" name="HumanWrenchWrapper">
      <param name="name">/HDE/HumanWrenchWrapper/wrench:o</param>
      <param name="period">10</param>
      <action phase="startup" level="5" type="attach">
        <paramlist name="networks">
            <elem name="HumanWrenchWrapperLabel">HumanWrenchProvider</elem>
        </paramlist>
      </action>
      <action phase="shutdown" level="5" type="detach" />
    </device>

    <device type="analogServer" name="HumanWrenchPublisher">
        <param name="name">/HDE/HumanWrenchPublisher/wrench:o</param>
        <param name="period">20</param>
        <param name="channels">24</param>
        <paramlist name="ports">
            <elem name="FirstSetOfChannels">0 5 0 5</elem>
            <elem name="SecondSetOfChannels">6 11 0 5</elem>
            <elem name="ThirdSetOfChannels">12 17 0 5</elem>
            <elem name="FourthSetOfChannels">18 23 0 5</elem>
        </paramlist>
        <group name="ROS">
            <param name="useROS">true</param>
            <param name="ROS_topicName">(/HDE/WrenchStamped/LeftFoot /HDE/WrenchStamped/RightFoot /HDE/WrenchStamped/LeftHandCOM /HDE/WrenchStamped/RightHandCOM)</param>
            <param name="ROS_nodeName">/HDE/HumanWrenchPublisherNode</param>
            <param name="ROS_msgType">geometry_msgs/WrenchStamped</param>
            <param name="frame_id">(Human/LeftFoot Human/RightFoot Human/LeftHandCOM Human/RightHandCOM)</param>
        </group>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanWrenchPublisherLabel">HumanWrenchProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="4" type="detach" />
    </device>

    
    <device type="human_dynamics_estimator" name="HumanDynamicsEstimator">
        <param name="period">0.100</param>
        <param extern-name="model" name="urdf">humanSubject03_48dof.urdf</param>
        <param name="baseLink">Pelvis</param>
        <param name="number_of_wrench_sensors">4</param>
        <param name="wrench_sensors_link_name">(LeftFoot RightFoot LeftHandCOM RightHandCOM)</param>
        <group name="PRIORS">
            <param name="mu_dyn_variables">0.0</param>
            <param name="cov_dyn_variables">1.0</param>
            <param name="cov_dyn_constraints">0.0001</param>
            <param name="cov_measurements_ACCELEROMETER_SENSOR">(0.0011 0.0011 0.0011)</param>
            <param name="cov_measurements_GYROSCOPE_SENSOR">(0.00011 0.00011 0.00011)</param>
            <param name="cov_measurements_DOF_ACCELERATION_SENSOR">0.666e-5</param>
            <group name="cov_measurements_NET_EXT_WRENCH_SENSOR">
                <param name="value">1e-6</param>
                <param name="specific_elements">()</param>
                <param name="LeftFoot">(0.0589998348 0.0589998348 0.0359999712 0.002250000225 0.002250000225 0.56e-3)</param>
                <param name="RightFoot">(0.0589998348 0.0589998348 0.0359999712 0.002250000225 0.002250000225 0.56e-3)</param>
            </group>
        </group>
        <param name="jointList">("jT9T8_rotx",
                                 "jT9T8_rotz",
                                 "jRightShoulder_rotx",
                                 "jRightShoulder_roty",
                                 "jRightShoulder_rotz",
                                 "jRightElbow_roty",
                                 "jRightElbow_rotz",
                                 "jLeftShoulder_rotx",
                                 "jLeftShoulder_roty",
                                 "jLeftShoulder_rotz",
                                 "jLeftElbow_roty",
                                 "jLeftElbow_rotz",
                                 "jLeftHip_rotx",
                                 "jLeftHip_roty",
                                 "jLeftHip_rotz",
                                 "jLeftKnee_roty",
                                 "jLeftKnee_rotz"
                                 "jLeftAnkle_rotx",
                                 "jLeftAnkle_roty",
                                 "jLeftAnkle_rotz",
                                 "jLeftBallFoot_roty",
                                 "jRightHip_rotx",
                                 "jRightHip_roty",
                                 "jRightHip_rotz",
                                 "jRightKnee_roty",
                                 "jRightKnee_rotz",
                                 "jRightAnkle_rotx",
                                 "jRightAnkle_roty",
                                 "jRightAnkle_rotz",
                                 "jRightBallFoot_roty",
                                 "jL5S1_roty",
                                 "jRightWrist_rotz",
                                 "jRightWrist_rotx",
                                 "jLeftWrist_rotz",
                                 "jLeftWrist_rotx",
                                 "jRightHandCOM",
                                 "jLeftHandCOM")
        </param>
        <group name="SENSORS_REMOVAL">
            <param name="GYROSCOPE_SENSOR">*</param>
            <param name="THREE_AXIS_ANGULAR_ACCELEROMETER_SENSOR">*</param>
        </group>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanDynamicsEstimatorLabel1">HumanStateProvider</elem>
                <elem name="HumanDynamicsEstimatorLabel2">HumanWrenchProvider</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_dynamics_wrapper" name="HumanDynamicsWrapper">
        <param name="period">0.1</param>
        <param name="outputPort">/HDE/HumanDynamicsWrapper/torques:o</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanDynamicsWrapperLabel">HumanDynamicsEstimator</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="5" type="detach"/>
    </device>

    <device type="human_dynamics_publisher" name="HumanDynamicsPublisher">
        <param name="period">0.020</param>
        <param name="parentLinkNames">(LeftFoot LeftLowerLeg LeftUpperLeg LeftHand LeftForeArm LeftUpperArm RightFoot RightLowerLeg RightUpperLeg RightHand RightForeArm RightUpperArm L5)</param>
        <param name="sphericalJointNames">(jLeftAnkle jLeftKnee jLeftHip jLeftWrist jLeftElbow jLeftShoulder jRightAnkle jRightKnee jRightHip jRightWrist jRightElbow jRightShoulder jL5S1)</param>
        <param name="topicPrefix">/HumanEffortBridge</param>
        <param name="tfPrefix">Human</param>
        <action phase="startup" level="5" type="attach">
            <paramlist name="networks">
                <elem name="HumanDynamicsPublisherLabel">HumanDynamicsEstimator</elem>
            </paramlist>
        </action>
        <action phase="shutdown" level="4" type="detach"/>
    </device>

</robot>
